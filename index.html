function doGet(e) {
  const action = e.parameter.action;

  if (action === "availability") {
    return getAvailability(e);
  }

  if (action === "approve") {
    return handleApproval(e.parameter.id, true);
  }

  if (action === "reject") {
    return handleApproval(e.parameter.id, false);
  }

  return ContentService
    .createTextOutput("Invalid action")
    .setMimeType(ContentService.MimeType.TEXT);
}

function getAvailability(e) {
  const date = e.parameter.date;

  if (!date) {
    return ContentService
      .createTextOutput(JSON.stringify({ error: "Missing date" }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const bookings = ss.getSheetByName("Bookings").getDataRange().getValues();

  const settingsSheet = ss.getSheetByName("Settings");
  const settingsRaw = settingsSheet.getRange("A1:A").getValues().filter(r => r[0] !== "");
  const settings = settingsRaw.map(r =>
    Utilities.formatDate(new Date(r[0]), Session.getScriptTimeZone(), "HH:mm")
  );

  const takenSlots = bookings
    .filter(r => r[5] === date && r[6])
    .map(r => r[6]);

  const available = settings.filter(time => !takenSlots.includes(time));

  return ContentService
    .createTextOutput(JSON.stringify({ available }))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const data = Object.fromEntries(e.postData.contents.split("&").map(p => p.split("=")).map(([k,v]) => [k, decodeURIComponent(v)]));

  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Bookings");
  const id = Utilities.getUuid();

  sheet.appendRow([
    id,
    data.name,
    data.email,
    data.phone,
    data.service,
    data.date,
    data.time,
    "Pending",
    false
  ]);

  const webAppUrl = "https://script.google.com/macros/s/AKfycbxGf8dkskolT9_C56wLuzG656tw4iodwtUrJRXtB39cmJyz2Nv9_Y00isjYFm74gzJOug/exec";

  GmailApp.sendEmail(
    data.email,
    "JessMakeUP — Appointment Request Received ✨",
    "",
    { htmlBody: `
      <p>Hi ${data.name},</p>
      <p>Your appointment request has been received.</p>
      <p><strong>${data.service}</strong> on <strong>${data.date}</strong> at <strong>${data.time}</strong></p>
    `}
  );

  GmailApp.sendEmail(
    "ing.arthur03@gmail.com",
    "New appointment request received",
    "",
    { htmlBody: `
      <p>New booking:</p>
      <p>${data.name} — ${data.service}</p>
      <p>${data.date} at ${data.time}</p>
      <p>
        <a href="${webAppUrl}?action=approve&id=${id}">Approve</a> |
        <a href="${webAppUrl}?action=reject&id=${id}">Reject</a>
      </p>
    `}
  );

  return ContentService
    .createTextOutput(JSON.stringify({ status: "ok" }))
    .setMimeType(ContentService.MimeType.JSON);
}

function handleApproval(id, approved) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("Bookings");
  const data = sheet.getDataRange().getValues();

  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === id) {

      sheet.getRange(i + 1, 8).setValue(approved ? "Approved" : "Rejected");
      sheet.getRange(i + 1, 9).setValue(approved ? false : true);

      if (approved) {
        sendConfirmationEmail(
          data[i][1],
          data[i][2],
          data[i][4],
          data[i][5],
          data[i][6]
        );
      }

      return ContentService.createTextOutput(
        approved ? "Appointment approved ✔️" : "Appointment rejected ❌"
      );
    }
  }

  return ContentService.createTextOutput("ID not found");
}

function sendConfirmationEmail(name, email, service, date, time) {
  GmailApp.sendEmail(
    email,
    "JessMakeUP — Appointment Confirmed ✨",
    "",
    { htmlBody: `
      <p>Your appointment is confirmed:</p>
      <p>${service} — ${date} at ${time}</p>
    `}
  );
}
